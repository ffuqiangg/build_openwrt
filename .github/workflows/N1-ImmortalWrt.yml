name: N1-ImmortalWrt

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - N1-ImmortalWrt

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: "ubuntu-24.04"

    env:
      DEBIAN_FRONTEND: noninteractive
      build_os: "cachyos"
      build_success: ""

    steps:
    - if: github.event.repository.owner.id == github.event.sender.id
      name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      run: |
        echo -e "ğŸ’¬ Server information \n"
        echo -e "ğŸ’» Server running on Ubuntu: [ Release: $(cat /etc/os-release | grep VERSION_CODENAME | cut -d '=' -f2) / Host: $(arch) ] \n"
        echo -e "ğŸ§® Server CPU configuration information: \n$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo -e "ğŸ’¾ Server memory usage: \n$(free -h) \n"
        echo -e "ğŸ—ƒï¸ Server space usag: \n$(df -hT ${{ github.workspace }}) \n"

    - name: å‡†å¤‡å¯ç”¨ç©ºé—´
      uses: AdityaGarg8/remove-unwanted-software@v5
      with:
        remove-dotnet: true
        remove-android: true
        remove-haskell: true
        remove-codeql: true
        remove-docker-images: true
        remove-large-packages: true
        remove-cached-tools: true
        remove-swapfile: true

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v6

    - name: å‡†å¤‡å®¹å™¨ ( init.sh )
      run: bash scripts/init.sh

    - name: å‡†å¤‡æºç  ( prepare.sh )
      run: d "cd ${ffdir} && bash scripts/immortalwrt/prepare.sh"

    - name: å‡†å¤‡ç¼–è¯‘
      run: |
        d '
          p "å¤„ç†èœå•"
          cd ${wrtdir}/feeds/luci && bash ${ffdir}/scripts/menu.sh
          cd ${wrtdir}/package/add && bash ${ffdir}/scripts/menu.sh

          p "å±•å¼€é…ç½®"
          cd ${wrtdir}
          cp ${ffdir}/scripts/immortalwrt/config.seed .config
          make defconfig
        '

    - name: å‹ç¼©ç¼–è¯‘ç›®å½•
      run: |
        d '
          cd ${workdir}
          cp -r ${ffdir} ${wrtdir}/
          tar -cf - $(basename ${wrtdir})/ | zstd -19 -T0 > wrt_end.tar.zst
          rm -rf ${wrtdir}/$(basename ${ffdir})
        '

    - name: ä¸Šä¼ ç¼–è¯‘ç›®å½•
      uses: actions/upload-artifact@main
      with:
        name: wrt_end
        path: ${{ env.workdir_host }}/wrt_end.tar.zst
        compression-level: 0

    - name: ç¼“å­˜
      uses: HiGarfield/cachewrtbuild@main
      with:
        mixkey: immortalwrt
        prefix: ${{ env.workdir_host }}/openwrt

    - name: å¼€å§‹ç¼–è¯‘ ImmortalWrt
      run: |
        d '
          cd ${wrtdir}
          p "å¼€å§‹ä¸‹è½½"
          make download -j$(($(nproc) + 1))
          p "å¼€å§‹ç¼–è¯‘"
          make -j$(($(nproc) + 1))
          if [ $? -ne 0 ]; then
            p "ï¼ï¼ç¼–è¯‘å¤±è´¥ï¼ï¼å¼€å¯å•çº¿ç¨‹"
            make -j1 V=s
          else
            p "ç¼–è¯‘æˆåŠŸ"
            . set_env build_success "true"
          fi

          p "æ‰“åŒ…æ—¥å¿—"
          tar -cf - logs/ | zstd -19 -T0 > "${workdir}/logs_immortalwrt.tar.zst"

          [ "${build_success}" == "true" ] || exit 1
        '

        p "æ‰“å°å‰©ä½™ç©ºé—´"
        df -h

    - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      uses: actions/upload-artifact@main
      with:
        name: logs
        path: ${{ env.workdir_host }}/logs_immortalwrt.tar.zst
        compression-level: 0

    - name: æ‰“åŒ…å›ºä»¶
      uses: ffuqiangg/amlogic-s9xxx-openwrt@main
      with:
        openwrt_path: ${{ env.workdir_host }}/openwrt/bin/targets/*/*/*rootfs.tar.gz
        openwrt_board: s905d
        kernel_repo: ffuqiangg/kernel_${{ env.current_version }}.y
        openwrt_kernel: ${{ env.kernel_version }}
        kernel_usage: stable
        auto_kernel: false
        openwrt_size: 820
        openwrt_ip: 192.168.1.99
        build_date: ${{ env.build_date }}

    - if: env.build_success == 'true'
      name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@main
      with:
        name: firmware
        path: ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz
        compression-level: 0

    - if: github.event_name == 'repository_dispatch' && env.build_success == 'true'
      name: æ•´ç†æ–‡ä»¶
      run: |
        p "å°†åŸå§‹å›ºä»¶ç§»åŠ¨åˆ°å·¥ä½œç›®å½•"
        cd ${{ env.workdir_host }}
        rm -rf ./artifact/
        mkdir -p ./artifact/
        cp ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz ./artifact/

        d '
          p "é‡æ–°æ‰“åŒ…å›ºä»¶"
          cd ${workdir}/artifact/
          7z a -tzip N1-ImmortalWrt-${{ env.latest_release }}-${{ env.build_date }}.zip *.img.gz
        '

        p "æ‰“å°å‰©ä½™ç©ºé—´"
        df -h

    - if: github.event_name == 'repository_dispatch' && env.build_success == 'true'
      name: å‘å¸ƒ release
      uses: ncipollo/release-action@main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag: ${{ env.build_date }}
        allowUpdates: true
        replacesArtifacts: true
        artifacts: ./artifact/*.zip
        bodyFile: ./doc/release.md

    - if: github.event_name == 'repository_dispatch' && env.build_success == 'true'
      name: TG é€šçŸ¥
      run: |
        files=$(curl -fsSL https://github.com/ffuqiangg/build_openwrt/releases/expanded_assets/${{ env.build_date }} | \
          grep -oE "N1-.*\.zip" | sort -u | wc -l)
        date="
        ${{ env.build_date }} å›ºä»¶å·²å‘å¸ƒ
        ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£ï¿£
        ğŸ“– æ›´æ–°å†…å®¹ NEW
        "
        url="

        ğŸ“ å›ºä»¶ä¸‹è½½åœ°å€
        https://github.com/ffuqiangg/build\_openwrt/releases/tag/${{ env.build_date }}
        "
        new="$(sed -n '/æ›´æ–°å†…å®¹/,$p' ./doc/release.md | sed '1,2d' | sed 's/^-/ãƒ»/g')"
        msg="${date}${new}${url}"
        if [ "${files}" == '6' ]; then
          curl "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO }}&text=${msg}&parse_mode=MarkDown&disable_web_page_preview=false"
        fi
